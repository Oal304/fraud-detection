{% extends 'base.html' %}
{% load static %}

{% block title %}Apply for Loan - VeriLoan{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header text-center">
                <h4 class="mb-2">
                    <i class="fas fa-file-contract me-2"></i>
                    Loan Application
                </h4>
                <p class="text-muted mb-0">Secure and AI-protected application process</p>
            </div>
            <div class="card-body">
                <form id="loanForm" method="post" action="{% url 'fraud_detection:apply_for_loan_enhanced' %}">
                    {% csrf_token %}
                    
                    <!-- Progress Indicator -->
                    <div class="progress mb-4" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>

                    <!-- Personal Information Section -->
                    <div class="section active" id="section-1">
                        <h5 class="section-title">
                            <i class="fas fa-user me-2"></i>Personal Information
                        </h5>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="full_name" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="full_name" name="full_name" required
                                       placeholder="Enter your full legal name">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="email" name="email" required
                                       placeholder="your.email@example.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" id="phone" name="phone" required
                                       placeholder="+234 XXX XXX XXXX">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Residential Address *</label>
                            <input type="text" class="form-control" id="address" name="address" required
                                   placeholder="Enter your complete residential address">
                        </div>

                        <div class="text-end">
                            <button type="button" class="btn btn-primary" onclick="nextSection(1)">
                                Next <i class="fas fa-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Employment Information Section -->
                    <div class="section" id="section-2" style="display: none;">
                        <h5 class="section-title">
                            <i class="fas fa-briefcase me-2"></i>Employment Information
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="employment_status" class="form-label">Employment Status *</label>
                                <select class="form-select" id="employment_status" name="employment_status" required>
                                    <option value="">Select Status</option>
                                    <option value="Employed">Employed</option>
                                    <option value="Self-Employed">Self-Employed</option>
                                    <option value="Unemployed">Unemployed</option>
                                    <option value="Student">Student</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="occupation" class="form-label">Occupation/Business *</label>
                                <input type="text" class="form-control" id="occupation" name="occupation" required
                                       placeholder="Your job title or business type">
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-primary" onclick="prevSection(2)">
                                <i class="fas fa-arrow-left me-1"></i> Previous
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextSection(2)">
                                Next <i class="fas fa-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Loan Details Section -->
                    <div class="section" id="section-3" style="display: none;">
                        <h5 class="section-title">
                            <i class="fas fa-money-bill-wave me-2"></i>Loan Details
                        </h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="amount_requested" class="form-label">Loan Amount (₦) *</label>
                                <input type="number" class="form-control" id="amount_requested" name="amount_requested" 
                                       min="10000" max="5000000" required placeholder="10000">
                                <div class="form-text">Minimum: ₦10,000 | Maximum: ₦5,000,000</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="repayment_duration" class="form-label">Repayment Duration *</label>
                                <select class="form-select" id="repayment_duration" name="repayment_duration" required>
                                    <option value="">Select Duration</option>
                                    <option value="3 months">3 months</option>
                                    <option value="6 months">6 months</option>
                                    <option value="12 months">12 months</option>
                                    <option value="24 months">24 months</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="purpose" class="form-label">Purpose of Loan *</label>
                            <textarea class="form-control" id="purpose" name="purpose" rows="3" required
                                      placeholder="Please describe how you plan to use this loan"></textarea>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Privacy Notice:</strong> Your application will be processed using AI-powered fraud detection 
                            to ensure security. All information is kept confidential.
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-primary" onclick="prevSection(3)">
                                <i class="fas fa-arrow-left me-1"></i> Previous
                            </button>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>
                                Submit Application
                            </button>
                        </div>
                    </div>

                    <!-- Hidden fields for fraud detection -->
                    <input type="hidden" id="visitor_id" name="visitor_id">
                    <input type="hidden" id="extended_metadata" name="extended_metadata">
                </form>
            </div>
        </div>

        <!-- Security Features Info -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="text-center">
                    <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                    <h6>AI Protection</h6>
                    <small class="text-muted">Advanced fraud detection</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <i class="fas fa-lock fa-2x text-warning mb-2"></i>
                    <h6>Encrypted Data</h6>
                    <small class="text-muted">Your information is secure</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <i class="fas fa-clock fa-2x text-info mb-2"></i>
                    <h6>Quick Processing</h6>
                    <small class="text-muted">Get response within minutes</small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.section {
    min-height: 400px;
}

.section-title {
    color: var(--royal-purple);
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--warm-amber);
}

.form-control, .form-select {
    border-radius: 8px;
    padding: 12px 15px;
}

.form-control:focus, .form-select:focus {
    border-color: var(--warm-amber);
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}

.btn {
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 500;
}

.progress-bar {
    background-color: var(--royal-purple);
    transition: width 0.3s ease;
}

.card-body {
    padding: 2rem;
}

@media (max-width: 768px) {
    .card-body {
        padding: 1.5rem;
    }
    
    .section {
        min-height: auto;
    }
}
</style>

<script>
// Multi-step form functionality
let currentSection = 1;
const totalSections = 3;

function nextSection(section) {
    if (validateSection(section)) {
        document.getElementById(`section-${section}`).style.display = 'none';
        currentSection++;
        document.getElementById(`section-${currentSection}`).style.display = 'block';
        updateProgress();
    }
}

function prevSection(section) {
    document.getElementById(`section-${section}`).style.display = 'none';
    currentSection--;
    document.getElementById(`section-${currentSection}`).style.display = 'block';
    updateProgress();
}

function validateSection(section) {
    const sectionElement = document.getElementById(`section-${section}`);
    const requiredFields = sectionElement.querySelectorAll('[required]');
    
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            field.focus();
            showToast('Please fill in all required fields', 'warning');
            return false;
        }
    }
    return true;
}

function updateProgress() {
    const progress = (currentSection / totalSections) * 100;
    document.querySelector('.progress-bar').style.width = progress + '%';
}

function showToast(message, type = 'info') {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${message}</span>
            <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
});

window.fingerprintjsPublicKey = "{{ fingerprintjs_public_key }}";
</script>
<script src="{% static 'js/fraud_detection.js' %}"></script>
{% endblock %}