{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - VeriLoan{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>VeriLoan Admin Dashboard</h2>
        <p class="text-muted">AI-Powered Fraud Detection Analytics</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="total-applications">0</h4>
                        <p class="mb-0">Total Applications</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-file-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="high-risk-count">0</h4>
                        <p class="mb-0">High Risk</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="anomalies-count">0</h4>
                        <p class="mb-0">AI Anomalies</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-robot fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="approved-count">0</h4>
                        <p class="mb-0">Approved</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Controls -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5>Quick Actions</h5>
                <button class="btn btn-primary me-2" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button class="btn btn-info me-2" onclick="runBatchAnalysis()">
                    <i class="fas fa-brain"></i> Run ML Analysis
                </button>
                <button class="btn btn-secondary me-2" onclick="exportData()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
                <button class="btn btn-success" onclick="showBulkActions()">
                    <i class="fas fa-tasks"></i> Bulk Actions
                </button>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5>Filters</h5>
                <div class="row">
                    <div class="col-6">
                        <select class="form-select" id="status-filter" onchange="filterApplications()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approve">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="flagged">Flagged</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <select class="form-select" id="risk-filter" onchange="filterApplications()">
                            <option value="">All Risk Levels</option>
                            <option value="low">Low Risk (0-40)</option>
                            <option value="medium">Medium Risk (41-70)</option>
                            <option value="high">High Risk (71-100)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Applications Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Recent Applications</h5>
        <div class="text-muted">
            <small id="last-updated">Last updated: Never</small>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="applications-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="form-check-input" id="select-all">
                            ID
                        </th>
                        <th>Applicant</th>
                        <th>Amount</th>
                        <th>Risk Score</th>
                        <th>ML Insights</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Loading applications...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ML Insights Modal -->
<div class="modal fade" id="ml-insights-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI/ML Fraud Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Content will be dynamically populated -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Analysis Modal -->
<div class="modal fade" id="batch-analysis-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Batch ML Analysis Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="batch-results-content">
                    <!-- Results will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom styles for dashboard */
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.table th {
    font-weight: 600;
    background-color: #f8f9fa;
}

.risk-badge {
    font-size: 0.8em;
    padding: 0.25em 0.5em;
}

.risk-low { background-color: #d4edda; color: #155724; }
.risk-medium { background-color: #fff3cd; color: #856404; }
.risk-high { background-color: #f8d7da; color: #721c24; }

.anomaly-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
}

.anomaly-detected { background-color: #dc3545; }
.anomaly-normal { background-color: #28a745; }

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .card-body h4 {
        font-size: 1.5rem;
    }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script>
// Dashboard JavaScript
let allApplications = [];
let filteredApplications = [];

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Load dashboard data
async function loadDashboardData() {
    try {
        const response = await fetch('/admin/dashboard-data/', {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load dashboard data');
        }
        
        const data = await response.json();
        allApplications = data.applications || [];
        filteredApplications = [...allApplications];
        
        updateStats(data.stats || {});
        updateApplicationsTable();
        
        document.getElementById('last-updated').textContent = 
            `Last updated: ${new Date().toLocaleTimeString()}`;
            
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showError('Failed to load dashboard data');
    }
}

function updateStats(stats) {
    document.getElementById('total-applications').textContent = stats.total || 0;
    document.getElementById('high-risk-count').textContent = stats.high_risk || 0;
    document.getElementById('anomalies-count').textContent = stats.anomalies || 0;
    document.getElementById('approved-count').textContent = stats.approved || 0;
}

function updateApplicationsTable() {
    const tbody = document.querySelector('#applications-table tbody');
    
    if (filteredApplications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No applications found</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredApplications.map(app => `
        <tr class="application-row" data-application-id="${app.id}">
            <td>
                <input type="checkbox" class="form-check-input application-checkbox" value="${app.id}">
                <small>${app.id.substring(0, 8)}...</small>
            </td>
            <td>
                <strong>${app.full_name}</strong><br>
                <small class="text-muted">${app.email}</small>
            </td>
            <td>$${parseFloat(app.amount_requested || 0).toLocaleString()}</td>
            <td>
                <span class="badge risk-badge ${getRiskClass(app.risk_score)}">
                    ${app.risk_score}/100
                </span>
            </td>
            <td>
                <span class="anomaly-indicator ${app.ml_anomaly ? 'anomaly-detected' : 'anomaly-normal'}"></span>
                ${app.behavioral_risk || 'N/A'}
            </td>
            <td>
                <span class="badge bg-${getStatusColor(app.status)}">
                    ${app.status}
                </span>
            </td>
            <td><small>${new Date(app.application_date).toLocaleDateString()}</small></td>
            <td>
                <button class="btn btn-sm btn-info me-1" onclick="getMLInsights('${app.id}')" title="ML Insights">
                    <i class="fas fa-brain"></i>
                </button>
                <button class="btn btn-sm btn-primary me-1" onclick="viewDetails('${app.id}')" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-success" onclick="quickStatusUpdate('${app.id}', 'APPROVE')" title="Quick Approve" ${app.status === 'APPROVE' ? 'disabled' : ''}>
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="quickStatusUpdate('${app.id}', 'REJECT')" title="Quick Reject" ${app.status === 'REJECT' ? 'disabled' : ''}>
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="quickStatusUpdate('${app.id}', 'FLAGGED')" title="Flag for Review" ${app.status === 'FLAGGED' ? 'disabled' : ''}>
                        <i class="fas fa-flag"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getRiskClass(score) {
    if (score <= 40) return 'risk-low';
    if (score <= 70) return 'risk-medium';
    return 'risk-high';
}

function getStatusColor(status) {
    switch(status.toLowerCase()) {
        case 'approve': return 'success';
        case 'reject': 
        case 'rejected': return 'danger';
        case 'pending': return 'warning';
        case 'flagged': return 'info';
        default: return 'secondary';
    }
}

function filterApplications() {
    const statusFilter = document.getElementById('status-filter').value;
    const riskFilter = document.getElementById('risk-filter').value;
    
    filteredApplications = allApplications.filter(app => {
        let matchesStatus = !statusFilter || app.status.toLowerCase() === statusFilter;
        let matchesRisk = true;
        
        if (riskFilter) {
            const risk = app.risk_score;
            switch(riskFilter) {
                case 'low': matchesRisk = risk <= 40; break;
                case 'medium': matchesRisk = risk > 40 && risk <= 70; break;
                case 'high': matchesRisk = risk > 70; break;
            }
        }
        
        return matchesStatus && matchesRisk;
    });
    
    updateApplicationsTable();
}

// === STATUS UPDATE FUNCTIONS ===
async function quickStatusUpdate(applicationId, newStatus) {
    if (!confirm(`Are you sure you want to ${newStatus.toLowerCase()} this application?`)) {
        return;
    }
    
    // Ask if user wants to send notification for quick actions
    const sendNotification = confirm(`Send email notification to the applicant about this ${newStatus.toLowerCase()} decision?`);
    
    try {
        const response = await fetch(`/admin/application/${applicationId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                status: newStatus,
                reason: `Quick ${newStatus.toLowerCase()} by admin`,
                send_notification: sendNotification
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            let successMessage = `Application ${newStatus.toLowerCase()}d successfully!`;
            
            // Show email notification confirmation for quick actions
            if (sendNotification) {
                successMessage += `\n\n📧 Demo: Email notification sent to applicant`;
                
                setTimeout(() => {
                    showEmailNotificationConfirmation(
                        result.applicant_email || 'applicant@example.com', 
                        newStatus, 
                        `Quick ${newStatus.toLowerCase()} by admin`
                    );
                }, 1000);
            }
            
            showSuccess(successMessage);
            loadDashboardData(); // Refresh the table
        } else {
            showError('Failed to update status: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error updating application status:', error);
        showError('Error updating application status');
    }
}

function showStatusUpdateForm(applicationId) {
    const modalHtml = `
        <div class="modal fade" id="status-update-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Update Application Status</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="status-update-form">
                            <div class="mb-3">
                                <label class="form-label">New Status</label>
                                <select class="form-select" id="new-status" required>
                                    <option value="">Select Status</option>
                                    <option value="PENDING">Pending Review</option>
                                    <option value="APPROVE">Approve</option>
                                    <option value="REJECT">Reject</option>
                                    <option value="FLAGGED">Flag for Review</option>
                                    <option value="UNDER_REVIEW">Under Review</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Reason/Comment</label>
                                <textarea class="form-control" id="status-reason" rows="3" placeholder="Enter reason for status change..."></textarea>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="send-notification">
                                    <label class="form-check-label">
                                        Send notification to applicant
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitStatusUpdate('${applicationId}')">Update Status</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('status-update-modal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    new bootstrap.Modal(document.getElementById('status-update-modal')).show();
}

async function submitStatusUpdate(applicationId) {
    const newStatus = document.getElementById('new-status').value;
    const reason = document.getElementById('status-reason').value;
    const sendNotification = document.getElementById('send-notification').checked;
    
    if (!newStatus) {
        showError('Please select a status');
        return;
    }
    
    try {
        const response = await fetch(`/admin/application/${applicationId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                status: newStatus,
                reason: reason,
                send_notification: sendNotification
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            let successMessage = `Application status updated to ${newStatus} successfully!`;
            
            // Show email notification confirmation (demo)
            if (sendNotification) {
                successMessage += `\n\n📧 Demo: Email notification sent to applicant`;
                
                setTimeout(() => {
                    showEmailNotificationConfirmation(
                        result.applicant_email || 'applicant@example.com', 
                        newStatus, 
                        reason
                    );
                }, 1000);
            }
            
            showSuccess(successMessage);
            bootstrap.Modal.getInstance(document.getElementById('status-update-modal')).hide();
            loadDashboardData(); // Refresh the table
        } else {
            showError('Failed to update status: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error updating application status:', error);
        showError('Error updating application status');
    }
}

// === ML INSIGHTS FUNCTIONS ===
async function getMLInsights(applicationId) {
    try {
        const response = await fetch(`/admin/ml-insights/?application_id=${applicationId}`);
        const insights = await response.json();
        
        if (response.ok) {
            displayDetailedInsights(insights);
        } else {
            showError('Failed to get ML insights: ' + (insights.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error getting ML insights:', error);
        showError('Error getting ML insights');
    }
}

function displayDetailedInsights(insights) {
    const modal = document.getElementById('ml-insights-modal');
    const modalBody = modal.querySelector('.modal-body');
    
    modalBody.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <h6>Application Overview</h6>
                <p><strong>ID:</strong> ${insights.application_id}</p>
                <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(insights.current_status)}">${insights.current_status}</span></p>
            </div>
            <div class="col-md-6">
                <h6>Risk Assessment</h6>
                <p><strong>Original:</strong> ${insights.original_risk_score}</p>
                <p><strong>Enhanced:</strong> ${insights.enhanced_risk_score} <span class="text-success">(+${insights.ml_risk_adjustment})</span></p>
            </div>
        </div>
        
        <h6>AI Behavioral Analysis</h6>
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Anomaly Score:</strong><br>
                        <code>${insights.behavioral_analysis.anomaly_score?.toFixed(3) || 'N/A'}</code>
                    </div>
                    <div class="col-md-4">
                        <strong>Risk Level:</strong><br>
                        <span class="badge ${insights.behavioral_analysis.behavioral_risk === 'high' ? 'bg-danger' : insights.behavioral_analysis.behavioral_risk === 'medium' ? 'bg-warning' : 'bg-success'}">
                            ${insights.behavioral_analysis.behavioral_risk || 'Unknown'}
                        </span>
                    </div>
                    <div class="col-md-4">
                        <strong>Anomaly Detected:</strong><br>
                        <span class="${insights.behavioral_analysis.anomaly_detected ? 'text-danger' : 'text-success'}">
                            ${insights.behavioral_analysis.anomaly_detected ? 'Yes ⚠️' : 'No ✅'}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <h6>Recommendations</h6>
        <div class="recommendations mb-3">
            ${insights.recommendations.map(rec => `
                <div class="alert alert-${rec.priority === 'high' ? 'danger' : 'warning'} py-2">
                    <strong>${rec.type.replace('_', ' ').toUpperCase()}:</strong> ${rec.message}<br>
                    <small><strong>Suggested Action:</strong> ${rec.action}</small>
                </div>
            `).join('')}
            ${insights.recommendations.length === 0 ? '<p class="text-muted">No specific recommendations at this time.</p>' : ''}
        </div>
        
        <h6>Technical Details</h6>
        <div class="card">
            <div class="card-body">
                <p class="mb-0 small text-muted">${insights.behavioral_analysis.analysis_details || 'No additional details available.'}</p>
            </div>
        </div>
    `;
    
    new bootstrap.Modal(modal).show();
}

// === BATCH ANALYSIS FUNCTIONS ===
async function runBatchAnalysis() {
    if (!confirm('Run ML analysis on recent applications? This may take a few moments.')) {
        return;
    }
    
    try {
        const recentIds = allApplications.slice(0, 20).map(app => app.id);
        
        const response = await fetch('/admin/batch-analysis/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ application_ids: recentIds })
        });
        
        const results = await response.json();
        
        if (response.ok) {
            displayBatchResults(results);
        } else {
            showError('Batch analysis failed: ' + (results.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error running batch analysis:', error);
        showError('Error running batch analysis');
    }
}

function displayBatchResults(results) {
    const modal = document.getElementById('batch-analysis-modal');
    const content = document.getElementById('batch-results-content');
    
    content.innerHTML = `
        <h6>Analysis Summary</h6>
        <div class="row mb-3">
            <div class="col-3">
                <div class="text-center">
                    <h4 class="text-primary">${results.summary.total_analyzed}</h4>
                    <small>Analyzed</small>
                </div>
            </div>
            <div class="col-3">
                <div class="text-center">
                    <h4 class="text-danger">${results.summary.high_risk_count}</h4>
                    <small>High Risk</small>
                </div>
            </div>
            <div class="col-3">
                <div class="text-center">
                    <h4 class="text-warning">${results.summary.anomalies_detected}</h4>
                    <small>Anomalies</small>
                </div>
            </div>
            <div class="col-3">
                <div class="text-center">
                    <h4 class="text-info">${results.summary.avg_risk_adjustment.toFixed(1)}</h4>
                    <small>Avg Adjustment</small>
                </div>
            </div>
        </div>
        
        <h6>Detailed Results</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Applicant</th>
                        <th>Original Risk</th>
                        <th>Enhanced Risk</th>
                        <th>Adjustment</th>
                        <th>Behavioral Risk</th>
                        <th>Anomaly</th>
                        <th>Recommendation</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.results.map(result => `
                        <tr>
                            <td>${result.applicant_name || 'N/A'}</td>
                            <td>${result.original_risk || 'N/A'}</td>
                            <td><strong>${result.enhanced_risk || 'N/A'}</strong></td>
                            <td class="${result.ml_adjustment > 10 ? 'text-warning' : 'text-success'}">+${result.ml_adjustment || 0}</td>
                            <td><span class="badge bg-${result.behavioral_risk === 'high' ? 'danger' : result.behavioral_risk === 'medium' ? 'warning' : 'success'}">${result.behavioral_risk || 'N/A'}</span></td>
                            <td>${result.anomaly_detected ? '⚠️' : '✅'}</td>
                            <td>${result.recommendation}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    new bootstrap.Modal(modal).show();
}

// === APPLICATION DETAILS FUNCTIONS ===
function viewDetails(applicationId) {
    showApplicationDetails(applicationId);
}

async function showApplicationDetails(applicationId) {
    try {
        const response = await fetch(`/admin/application/${applicationId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load application details');
        }
        
        const data = await response.json();
        displayApplicationDetailsModal(data);
        
    } catch (error) {
        console.error('Error loading application details:', error);
        showError('Failed to load application details');
    }
}

function displayApplicationDetailsModal(data) {
    const app = data.application;
    const visitor = data.visitor_info || {};
    const signals = data.smart_signals || {};
    const mlAnalysis = data.ml_analysis || {};
    const fraudAlerts = data.fraud_alerts || [];
    
    // Create or get the application details modal
    let modal = document.getElementById('application-details-modal');
    if (!modal) {
        const modalHtml = `
            <div class="modal fade" id="application-details-modal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Application Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="application-details-body">
                            <!-- Content will be populated here -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-info me-2" onclick="showStatusUpdateForm('${app.id}')">
                                <i class="fas fa-edit"></i> Update Status
                            </button>
                            <button type="button" class="btn btn-warning me-2" onclick="viewComments('${app.id}')">
                                <i class="fas fa-comment"></i> Comments
                            </button>
                            <button type="button" class="btn btn-primary" onclick="exportSingleApplication('${app.id}')">
                                <i class="fas fa-download"></i> Export Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('application-details-modal');
    }
    
    const modalBody = document.getElementById('application-details-body');
    modalBody.innerHTML = `
        <!-- Application Overview -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-user"></i> Applicant Information</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless table-sm">
                            <tr><td><strong>Full Name:</strong></td><td>${app.full_name}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${app.email}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${app.phone}</td></tr>
                            <tr><td><strong>Address:</strong></td><td>${app.address}</td></tr>
                            <tr><td><strong>Employment:</strong></td><td>${app.employment_status}</td></tr>
                            <tr><td><strong>Occupation:</strong></td><td>${app.occupation}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-money-bill-wave"></i> Loan Details</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless table-sm">
                            <tr><td><strong>Amount:</strong></td><td>$${parseFloat(app.amount_requested).toLocaleString()}</td></tr>
                            <tr><td><strong>Duration:</strong></td><td>${app.repayment_duration}</td></tr>
                            <tr><td><strong>Purpose:</strong></td><td>${app.purpose}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-${getStatusColor(app.status)}">${app.status}</span></td></tr>
                            <tr><td><strong>Risk Score:</strong></td><td><span class="badge ${getRiskClass(app.risk_score)}">${app.risk_score}/100</span></td></tr>
                            <tr><td><strong>Applied:</strong></td><td>${new Date(app.application_date).toLocaleString()}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Visitor Information -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-fingerprint"></i> Visitor Analysis</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless table-sm">
                            <tr><td><strong>Visitor ID:</strong></td><td><code>${visitor.visitor_id || 'N/A'}</code></td></tr>
                            <tr><td><strong>IP Address:</strong></td><td>${visitor.ip_address || 'N/A'}</td></tr>
                            <tr><td><strong>Public IP:</strong></td><td>${visitor.public_ip || 'N/A'}</td></tr>
                            <tr><td><strong>Browser:</strong></td><td>${visitor.browser_name || 'N/A'}</td></tr>
                            <tr><td><strong>OS:</strong></td><td>${visitor.os || 'N/A'}</td></tr>
                            <tr><td><strong>Device:</strong></td><td>${visitor.device || 'N/A'}</td></tr>
                            <tr><td><strong>Applications:</strong></td><td>${visitor.application_count || 0}</td></tr>
                            <tr><td><strong>Confidence:</strong></td><td>${((visitor.confidence_score || 0) * 100).toFixed(1)}%</td></tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-shield-alt"></i> Security Signals</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless table-sm">
                            <tr><td><strong>Bot:</strong></td><td>${signals.bot_detected ? '<span class="text-danger">Yes ⚠️</span>' : '<span class="text-success">No ✅</span>'}</td></tr>
                            <tr><td><strong>VPN:</strong></td><td>${signals.vpn_detected ? '<span class="text-danger">Yes ⚠️</span>' : '<span class="text-success">No ✅</span>'}</td></tr>
                            <tr><td><strong>Proxy:</strong></td><td>${signals.proxy_detected ? '<span class="text-warning">Yes ⚠️</span>' : '<span class="text-success">No ✅</span>'}</td></tr>
                            <tr><td><strong>Tor:</strong></td><td>${signals.tor_detected ? '<span class="text-danger">Yes ⚠️</span>' : '<span class="text-success">No ✅</span>'}</td></tr>
                            <tr><td><strong>Tampering:</strong></td><td>${signals.tampering_detected ? '<span class="text-danger">Yes ⚠️</span>' : '<span class="text-success">No ✅</span>'}</td></tr>
                            <tr><td><strong>Incognito:</strong></td><td>${signals.incognito ? '<span class="text-info">Yes</span>' : '<span class="text-muted">No</span>'}</td></tr>
                            <tr><td><strong>IP Blocklisted:</strong></td><td>${signals.ip_blocklisted ? '<span class="text-danger">Yes ⚠️</span>' : '<span class="text-success">No ✅</span>'}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-brain"></i> ML Analysis</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless table-sm">
                            <tr><td><strong>Anomaly Score:</strong></td><td><code>${mlAnalysis.anomaly_score?.toFixed(3) || 'N/A'}</code></td></tr>
                            <tr><td><strong>Anomaly Detected:</strong></td><td>${mlAnalysis.anomaly_detected ? '<span class="text-danger">Yes ⚠️</span>' : '<span class="text-success">No ✅</span>'}</td></tr>
                            <tr><td><strong>Cluster:</strong></td><td>${mlAnalysis.cluster_label || 'N/A'}</td></tr>
                            <tr><td><strong>Behavioral Risk:</strong></td><td><span class="badge bg-${mlAnalysis.behavioral_risk === 'high' ? 'danger' : mlAnalysis.behavioral_risk === 'medium' ? 'warning' : 'success'}">${mlAnalysis.behavioral_risk || 'Unknown'}</span></td></tr>
                            <tr><td><strong>Analysis Details:</strong></td><td><small>${mlAnalysis.analysis_details || 'No details available'}</small></td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fraud Alerts -->
        ${fraudAlerts.length > 0 ? `
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-exclamation-triangle text-warning"></i> Fraud Alerts (${fraudAlerts.length})</h6>
                    </div>
                    <div class="card-body">
                        ${fraudAlerts.map(alert => `
                            <div class="alert alert-warning">
                                <strong>Alert #${alert.id}:</strong> ${alert.reason}<br>
                                <small><strong>Risk Score:</strong> ${alert.risk_score} | <strong>Status:</strong> ${alert.status} | <strong>Date:</strong> ${new Date(alert.created_at).toLocaleString()}</small>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
        
        <!-- Location Information -->
        ${data.metadata?.ipInfo ? `
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-map-marker-alt"></i> Location Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless table-sm">
                                    <tr><td><strong>Country:</strong></td><td>${data.metadata.ipInfo.geolocation?.country?.name || 'Unknown'}</td></tr>
                                    <tr><td><strong>City:</strong></td><td>${data.metadata.ipInfo.geolocation?.city?.name || 'Unknown'}</td></tr>
                                    <tr><td><strong>Timezone:</strong></td><td>${data.metadata.ipInfo.geolocation?.timezone || 'Unknown'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless table-sm">
                                    <tr><td><strong>ISP:</strong></td><td>${data.metadata.ipInfo.asn?.name || 'Unknown'}</td></tr>
                                    <tr><td><strong>ASN:</strong></td><td>${data.metadata.ipInfo.asn?.asn || 'Unknown'}</td></tr>
                                    <tr><td><strong>Datacenter:</strong></td><td>${data.metadata.ipInfo.datacenter?.result ? 'Yes' : 'No'}</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
    `;
    
    // Update modal footer with current application ID
    const modalFooter = modal.querySelector('.modal-footer');
    modalFooter.innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-info me-2" onclick="showStatusUpdateForm('${app.id}')">
            <i class="fas fa-edit"></i> Update Status
        </button>
        <button type="button" class="btn btn-warning me-2" onclick="viewComments('${app.id}')">
            <i class="fas fa-comment"></i> Comments
        </button>
        <button type="button" class="btn btn-primary" onclick="exportSingleApplication('${app.id}')">
            <i class="fas fa-download"></i> Export Details
        </button>
    `;
    
    new bootstrap.Modal(modal).show();
}

// === BULK ACTIONS ===
function showBulkActions() {
    const selected = getSelectedApplications();
    if (selected.length === 0) {
        showError('Please select at least one application');
        return;
    }
    
    const modalHtml = `
        <div class="modal fade" id="bulk-actions-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Bulk Actions (${selected.length} applications)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="bulkStatusUpdate('APPROVE')">
                                <i class="fas fa-check"></i> Approve All Selected
                            </button>
                            <button class="btn btn-danger" onclick="bulkStatusUpdate('REJECT')">
                                <i class="fas fa-times"></i> Reject All Selected
                            </button>
                            <button class="btn btn-warning" onclick="bulkStatusUpdate('FLAGGED')">
                                <i class="fas fa-flag"></i> Flag All for Review
                            </button>
                            <button class="btn btn-info" onclick="bulkMLAnalysis()">
                                <i class="fas fa-brain"></i> Run ML Analysis on Selected
                            </button>
                            <button class="btn btn-primary" onclick="bulkExport()">
                                <i class="fas fa-download"></i> Export Selected Applications
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('bulk-actions-modal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    new bootstrap.Modal(document.getElementById('bulk-actions-modal')).show();
}

function getSelectedApplications() {
    return Array.from(document.querySelectorAll('.application-checkbox:checked')).map(cb => cb.value);
}

async function bulkStatusUpdate(newStatus) {
    const selected = getSelectedApplications();
    const reason = prompt(`Enter reason for ${newStatus.toLowerCase()}ing ${selected.length} applications:`);
    
    if (reason === null) return; // User cancelled
    
    try {
        const response = await fetch('/admin/bulk-update-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                application_ids: selected,
                status: newStatus,
                reason: reason || `Bulk ${newStatus.toLowerCase()} by admin`
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess(`${selected.length} applications updated successfully!`);
            bootstrap.Modal.getInstance(document.getElementById('bulk-actions-modal')).hide();
            loadDashboardData();
            clearAllSelections();
        } else {
            showError('Bulk update failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error performing bulk update:', error);
        showError('Error performing bulk update');
    }
}

function bulkMLAnalysis() {
    const selected = getSelectedApplications();
    
    if (!confirm(`Run ML analysis on ${selected.length} selected applications?`)) {
        return;
    }
    
    // Close bulk actions modal and run analysis
    bootstrap.Modal.getInstance(document.getElementById('bulk-actions-modal')).hide();
    
    // Use the selected IDs for batch analysis
    setTimeout(async () => {
        try {
            const response = await fetch('/admin/batch-analysis/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ application_ids: selected })
            });
            
            const results = await response.json();
            
            if (response.ok) {
                displayBatchResults(results);
            } else {
                showError('Batch analysis failed: ' + (results.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error running batch analysis:', error);
            showError('Error running batch analysis');
        }
    }, 500);
}

function bulkExport() {
    const selected = getSelectedApplications();
    const selectedParams = selected.map(id => `application_id=${id}`).join('&');
    window.location.href = `/admin/export-applications/?${selectedParams}`;
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('bulk-actions-modal')).hide();
}

// === COMMENTS SYSTEM ===
async function addComment(applicationId) {
    const comment = prompt('Enter your comment:');
    if (!comment || comment.trim() === '') return;
    
    try {
        const response = await fetch('/admin/add-comment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                application_id: applicationId,
                comment: comment.trim()
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess(`Comment added successfully! (Total: ${result.comment_count})`);
        } else {
            showError('Failed to add comment: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error adding comment:', error);
        showError('Error adding comment');
    }
}

async function viewComments(applicationId) {
    try {
        const response = await fetch(`/admin/get-comments/?application_id=${applicationId}`);
        const result = await response.json();
        
        if (response.ok) {
            displayCommentsModal(applicationId, result.comments);
        } else {
            showError('Failed to load comments: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error loading comments:', error);
        showError('Error loading comments');
    }
}

function displayCommentsModal(applicationId, comments) {
    const modalHtml = `
        <div class="modal fade" id="comments-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-comments"></i> Application Comments (${comments.length})
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${comments.length === 0 ? 
                            '<p class="text-muted text-center">No comments yet.</p>' : 
                            comments.map(comment => `
                                <div class="card mb-2">
                                    <div class="card-body py-2">
                                        <p class="mb-1">${comment.comment}</p>
                                        <small class="text-muted">
                                            <i class="fas fa-user"></i> ${comment.admin_user} • 
                                            <i class="fas fa-clock"></i> ${new Date(comment.timestamp).toLocaleString()}
                                        </small>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="addCommentFromModal('${applicationId}')">
                            <i class="fas fa-plus"></i> Add Comment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('comments-modal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    new bootstrap.Modal(document.getElementById('comments-modal')).show();
}

async function addCommentFromModal(applicationId) {
    await addComment(applicationId);
    // Refresh the comments modal
    setTimeout(() => viewComments(applicationId), 1000);
}

// === EMAIL NOTIFICATION (DEMO) ===
function showEmailNotificationConfirmation(email, status, reason) {
    const modalHtml = `
        <div class="modal fade" id="email-notification-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-envelope"></i> Email Notification Sent
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                        </div>
                        <div class="alert alert-success">
                            <h6>Email Successfully Sent!</h6>
                            <p class="mb-2"><strong>Recipient:</strong> ${email}</p>
                            <p class="mb-2"><strong>Status Update:</strong> ${status}</p>
                            ${reason ? `<p class="mb-2"><strong>Reason:</strong> ${reason}</p>` : ''}
                            <hr>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> Sent at ${new Date().toLocaleTimeString()}
                            </small>
                        </div>
                        <div class="text-muted small">
                            <p><strong>Email Content Includes:</strong></p>
                            <ul class="mb-0">
                                <li>Application status update</li>
                                <li>Next steps (if applicable)</li>
                                <li>Contact information for queries</li>
                                <li>Reference number for tracking</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                            <i class="fas fa-thumbs-up"></i> Great!
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('email-notification-modal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    new bootstrap.Modal(document.getElementById('email-notification-modal')).show();
}

// === EXPORT FUNCTIONS ===
function exportData() {
    window.location.href = '/admin/export-applications/';
}

function exportSingleApplication(applicationId) {
    window.location.href = `/admin/export-applications/?application_id=${applicationId}`;
}

// === ANALYTICS FUNCTIONS (Placeholders for now) ===
function showFraudReport() {
    showInfo('Fraud Report feature coming soon! This will show detailed fraud analytics and trends.');
}

function showApprovalStats() {
    showInfo('Approval Statistics feature coming soon! This will show approval rates and patterns.');
}

function showRiskAnalysis() {
    showInfo('Risk Analysis feature coming soon! This will show risk distribution and insights.');
}

// === UTILITY FUNCTIONS ===
function clearAllSelections() {
    document.querySelectorAll('.application-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
}

function refreshDashboard() {
    loadDashboardData();
    showSuccess('Dashboard refreshed successfully!');
}

function showSuccess(message) {
    const alertHtml = `
        <div class="alert alert-success alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" 
             id="success-alert">
            <i class="fas fa-check-circle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Remove any existing alerts
    const existingAlert = document.getElementById('success-alert');
    if (existingAlert) existingAlert.remove();
    
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = document.getElementById('success-alert');
        if (alert) alert.remove();
    }, 5000);
}

function showError(message) {
    const alertHtml = `
        <div class="alert alert-danger alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" 
             id="error-alert">
            <i class="fas fa-exclamation-circle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Remove any existing alerts
    const existingAlert = document.getElementById('error-alert');
    if (existingAlert) existingAlert.remove();
    
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto-dismiss after 7 seconds
    setTimeout(() => {
        const alert = document.getElementById('error-alert');
        if (alert) alert.remove();
    }, 7000);
}

function showInfo(message) {
    const alertHtml = `
        <div class="alert alert-info alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" 
             id="info-alert">
            <i class="fas fa-info-circle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Remove any existing alerts
    const existingAlert = document.getElementById('info-alert');
    if (existingAlert) existingAlert.remove();
    
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = document.getElementById('info-alert');
        if (alert) alert.remove();
    }, 5000);
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    
    // Refresh every 30 seconds
    setInterval(loadDashboardData, 30000);
    
    // Setup select all checkbox
    document.getElementById('select-all').addEventListener('change', function() {
        document.querySelectorAll('.application-checkbox').forEach(cb => {
            cb.checked = this.checked;
        });
    });
});
</script>
{% endblock %}